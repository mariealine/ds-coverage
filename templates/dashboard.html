<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DS Coverage Dashboard</title>
  <!-- __DS_INLINE_DATA__ -->
  <style>
    :root {
      --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-family-mono: "SF Mono", "Fira Code", "Cascadia Code", monospace;

      --text-main: oklch(0.21 0.034 264.665);
      --text-primary: oklch(0.373 0.034 259.733);
      --text-secondary: oklch(0.551 0.027 264.364);
      --text-tertiary: oklch(0.707 0.022 261.325);
      --text-complementary: oklch(1 0 0);

      --bg-base-primary: oklch(1 0 0);
      --bg-base-primary-hover: oklch(0.985 0.002 247.839);
      --bg-base-secondary: oklch(0.967 0.003 264.542);

      --color-danger: oklch(0.637 0.237 25.331);
      --color-warning: oklch(0.723 0.22 70.08);
      --color-success: oklch(0.723 0.219 149.579);
      --color-info: oklch(0.623 0.214 259.815);
      --color-accent: oklch(0.623 0.214 259.815);

      --border-default: oklch(0.928 0.006 264.531);
      --border-hover: oklch(0.872 0.01 258.338);

      --radius-4: 4px;
      --radius-6: 6px;
      --radius-8: 8px;
      --radius-12: 12px;

      --space-2: 2px; --space-4: 4px; --space-6: 6px; --space-8: 8px;
      --space-12: 12px; --space-16: 16px; --space-20: 20px; --space-24: 24px;
      --space-32: 32px; --space-48: 48px;

      --text-size-xxs: 11px; --text-size-xs: 13px; --text-size-default: 14px;
      --text-size-large: 16px; --text-size-xlarge: 20px; --text-size-hero: 36px;

      --font-weight-regular: 400; --font-weight-medium: 500;
      --font-weight-semibold: 600; --font-weight-bold: 700;

      --line-height: 145%;
      --letter-spacing: -0.03em;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-family);
      background: var(--bg-base-primary-hover);
      color: var(--text-main);
      line-height: var(--line-height);
      letter-spacing: var(--letter-spacing);
      padding: var(--space-24);
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Typescale helpers */
    .ts-xl-sb { font-size: var(--text-size-xlarge); font-weight: var(--font-weight-semibold); }
    .ts-l-m { font-size: var(--text-size-large); font-weight: var(--font-weight-medium); }
    .ts-d-m { font-size: var(--text-size-default); font-weight: var(--font-weight-medium); }
    .ts-d-r { font-size: var(--text-size-default); font-weight: var(--font-weight-regular); }
    .ts-xs-m { font-size: var(--text-size-xs); font-weight: var(--font-weight-medium); }
    .ts-xs-r { font-size: var(--text-size-xs); font-weight: var(--font-weight-regular); }
    .ts-xxs-m { font-size: var(--text-size-xxs); font-weight: var(--font-weight-medium); }
    .ts-xxs-r { font-size: var(--text-size-xxs); font-weight: var(--font-weight-regular); }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-32); gap: var(--space-16); flex-wrap: wrap; }
    .header h1 { font-size: var(--text-size-xlarge); font-weight: var(--font-weight-bold); letter-spacing: -0.02em; }
    .header .subtitle { color: var(--text-secondary); margin-top: var(--space-4); }
    .timestamp { color: var(--text-tertiary); background: var(--bg-base-secondary); padding: var(--space-4) var(--space-8); border-radius: var(--radius-6); }

    /* Hero ring */
    .hero { display: grid; grid-template-columns: 200px 1fr; gap: var(--space-32); background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); padding: var(--space-32); margin-bottom: var(--space-24); }
    .hero-ring { position: relative; width: 160px; height: 160px; margin: 0 auto; }
    .hero-ring svg { transform: rotate(-90deg); }
    .hero-ring .label { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .hero-ring .percent { font-size: var(--text-size-hero); font-weight: var(--font-weight-bold); letter-spacing: -0.03em; }
    .hero-ring .percent-label { color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }
    .hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-16); align-content: center; }
    .stat { padding: var(--space-16); border-radius: var(--radius-8); background: var(--bg-base-primary-hover); }
    .stat-value { font-size: 28px; font-weight: var(--font-weight-bold); letter-spacing: -0.02em; }
    .stat-label { color: var(--text-secondary); margin-top: var(--space-2); }

    /* Category cards */
    .categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--space-16); margin-bottom: var(--space-24); }
    .cat-card { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); padding: var(--space-20); cursor: pointer; transition: border-color 0.15s; }
    .cat-card:hover { border-color: var(--color-accent); }
    .cat-card.active { border-color: var(--color-accent); box-shadow: 0 0 0 1px var(--color-accent); }
    .cat-card .cat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-12); }
    .cat-card .cat-name { text-transform: uppercase; letter-spacing: 0.03em; }
    .cat-card .cat-icon { font-size: 18px; }
    .cat-card .cat-count { font-size: 32px; font-weight: var(--font-weight-bold); letter-spacing: -0.02em; }
    .cat-card .cat-files { color: var(--text-secondary); }
    .cat-bar { height: var(--space-4); background: var(--bg-base-secondary); border-radius: var(--space-2); margin-top: var(--space-12); overflow: hidden; }
    .cat-bar-fill { height: 100%; border-radius: var(--space-2); transition: width 0.3s; }

    /* Flags */
    .flags { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-16); margin-bottom: var(--space-24); }
    .flag-card { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-8); padding: var(--space-16); display: flex; align-items: center; gap: var(--space-12); }
    .flag-badge { padding: var(--space-4) 10px; border-radius: var(--radius-6); font-family: var(--font-family-mono); white-space: nowrap; }
    .flag-badge.simple { background: oklch(0.982 0.022 70.08); color: oklch(0.393 0.095 70.08); }
    .flag-badge.complex { background: oklch(0.971 0.013 17.38); color: oklch(0.505 0.213 27.518); }
    .flag-badge.todo { background: oklch(0.97 0.014 254.604); color: oklch(0.488 0.243 264.376); }
    .flag-count { font-size: var(--text-size-xlarge); font-weight: var(--font-weight-bold); }

    /* Toolbar */
    .toolbar { display: flex; gap: var(--space-12); margin-bottom: var(--space-16); align-items: center; flex-wrap: wrap; }
    .search-input { flex: 1; min-width: 200px; padding: var(--space-8) var(--space-12); border: 1px solid var(--border-default); border-radius: var(--radius-8); font-family: var(--font-family); outline: none; background: var(--bg-base-primary); }
    .search-input:focus { border-color: var(--color-accent); }
    .sort-select { padding: var(--space-8) var(--space-12); border: 1px solid var(--border-default); border-radius: var(--radius-8); font-family: var(--font-family); background: var(--bg-base-primary); cursor: pointer; }

    /* File table */
    .file-table-container { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); overflow: hidden; }
    .file-table { width: 100%; border-collapse: collapse; }
    .file-table th { text-align: left; padding: 10px var(--space-16); color: var(--text-secondary); background: var(--bg-base-primary-hover); border-bottom: 1px solid var(--border-default); cursor: pointer; user-select: none; text-transform: uppercase; letter-spacing: 0.05em; }
    .file-table th:hover { color: var(--text-main); }
    .file-table td { padding: var(--space-8) var(--space-16); border-bottom: 1px solid var(--border-default); vertical-align: top; }
    .file-table tr:last-child td { border-bottom: none; }
    .file-table tr:hover td { background: var(--bg-base-primary-hover); }
    .file-path { font-family: var(--font-family-mono); color: var(--color-accent); word-break: break-all; }
    .file-path:hover { text-decoration: underline; cursor: pointer; }
    .badge { display: inline-block; padding: var(--space-2) var(--space-6); border-radius: var(--radius-4); min-width: 24px; text-align: center; }
    .badge.zero { background: var(--bg-base-secondary); color: var(--text-tertiary); }

    /* Detail panel */
    .detail-panel { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); padding: var(--space-20); margin-top: var(--space-16); display: none; }
    .detail-panel.open { display: block; }
    .detail-close { background: none; border: 1px solid var(--border-default); border-radius: var(--radius-8); padding: var(--space-4) 10px; cursor: pointer; font-family: var(--font-family); }
    .violation-list { font-family: var(--font-family-mono); line-height: 1.8; }
    .violation-item { display: flex; gap: var(--space-12); padding: var(--space-4) var(--space-8); border-radius: var(--radius-4); }
    .violation-item:hover { background: var(--bg-base-primary-hover); }
    .violation-line { color: var(--text-tertiary); min-width: 50px; text-align: right; }
    .violation-match { color: var(--color-danger); font-weight: var(--font-weight-semibold); min-width: 160px; }
    .violation-context { color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Pagination */
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: var(--space-12) var(--space-16); color: var(--text-secondary); background: var(--bg-base-primary-hover); border-top: 1px solid var(--border-default); }
    .pagination button { padding: var(--space-6) var(--space-12); border: 1px solid var(--border-default); border-radius: var(--radius-8); background: var(--bg-base-primary); cursor: pointer; font-family: var(--font-family); }
    .pagination button:disabled { opacity: 0.4; cursor: default; }

    /* Tabs */
    .tab-bar { display: flex; gap: var(--space-2); margin-bottom: var(--space-24); border-bottom: 1px solid var(--border-default); }
    .tab-btn { padding: var(--space-8) var(--space-20); border: none; background: none; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: color 0.15s, border-color 0.15s; font-family: var(--font-family); }
    .tab-btn:hover { color: var(--text-main); }
    .tab-btn.active { color: var(--color-accent); border-bottom-color: var(--color-accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Roadmap */
    .phase-card { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); padding: var(--space-24); margin-bottom: var(--space-16); }
    .phase-header { display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-16); margin-bottom: var(--space-12); }
    .phase-title { display: flex; align-items: center; gap: var(--space-8); }
    .phase-number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: var(--color-accent); color: var(--text-complementary); flex-shrink: 0; }
    .phase-desc { color: var(--text-secondary); margin-bottom: var(--space-16); }
    .phase-stats { display: flex; gap: var(--space-24); margin-bottom: var(--space-16); }
    .phase-stat-value { font-weight: var(--font-weight-bold); }
    .phase-stat-label { color: var(--text-tertiary); }
    .phase-files { border-top: 1px solid var(--border-default); padding-top: var(--space-12); }
    .phase-files-toggle { background: none; border: none; color: var(--color-accent); cursor: pointer; font-family: var(--font-family); padding: 0; }
    .phase-files-toggle:hover { text-decoration: underline; }
    .phase-file-list { display: none; margin-top: var(--space-8); }
    .phase-file-list.open { display: block; }
    .phase-file-item { display: flex; justify-content: space-between; padding: var(--space-4) var(--space-8); border-radius: var(--radius-4); }
    .phase-file-item:hover { background: var(--bg-base-primary-hover); }
    .phase-file-path { font-family: var(--font-family-mono); color: var(--text-primary); }
    .phase-file-count { color: var(--text-secondary); flex-shrink: 0; }
    .biz-case { background: var(--bg-base-primary-hover); border-radius: var(--radius-8); padding: var(--space-12) var(--space-16); margin-bottom: var(--space-16); border-left: 3px solid var(--color-accent); }
    .dir-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--space-12); margin-bottom: var(--space-24); }
    .dir-card { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-8); padding: var(--space-16); }
    .dir-bar { display: flex; height: var(--space-6); border-radius: var(--space-4); overflow: hidden; background: var(--bg-base-secondary); margin-bottom: var(--space-6); }
    .dir-bar-fill { height: 100%; transition: width 0.3s; }
    .dir-stats { display: flex; justify-content: space-between; color: var(--text-secondary); }

    /* Token table */
    .token-table { width: 100%; border-collapse: collapse; background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); overflow: hidden; }
    .token-table th { text-align: left; padding: 10px var(--space-16); color: var(--text-secondary); background: var(--bg-base-primary-hover); border-bottom: 1px solid var(--border-default); text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
    .token-table td { padding: var(--space-8) var(--space-16); border-bottom: 1px solid var(--border-default); vertical-align: middle; }
    .token-table tr:last-child td { border-bottom: none; }
    .token-table tr:hover td { background: var(--bg-base-primary-hover); }
    .token-score-bar { display: flex; align-items: center; gap: var(--space-8); min-width: 140px; }
    .token-bar-track { flex: 1; height: var(--space-6); border-radius: var(--space-4); background: var(--bg-base-secondary); overflow: hidden; }
    .token-bar-fill { height: 100%; border-radius: var(--space-4); transition: width 0.3s; }
    .token-score-pct { min-width: 44px; text-align: right; font-weight: var(--font-weight-semibold); }

    /* API Rework */
    .api-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-12); align-content: center; }
    .api-stat { padding: var(--space-12); border-radius: var(--radius-8); background: var(--bg-base-primary-hover); text-align: center; }
    .api-stat.clickable { cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; border: 1px solid transparent; }
    .api-stat.clickable:hover { border-color: var(--color-accent); }
    .api-stat.clickable.active { border-color: var(--color-accent); box-shadow: 0 0 0 1px var(--color-accent); }
    .api-stat-value { font-size: 24px; font-weight: var(--font-weight-bold); letter-spacing: -0.02em; }
    .api-stat-label { color: var(--text-secondary); margin-top: var(--space-2); }
    .api-loc-btn { padding: var(--space-6) var(--space-16); border: 1px solid var(--border-default); border-radius: var(--radius-8); background: var(--bg-base-primary); cursor: pointer; font-family: var(--font-family); transition: all 0.15s; }
    .api-loc-btn:hover { border-color: var(--color-accent); }
    .api-loc-btn.active { background: var(--color-accent); color: var(--text-complementary); border-color: var(--color-accent); }
    .comp-card { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-8); padding: var(--space-16); margin-bottom: var(--space-8); display: grid; grid-template-columns: 1fr auto; gap: var(--space-16); align-items: start; }
    .comp-card:hover { border-color: var(--border-hover); }
    .comp-features { display: flex; gap: var(--space-6); flex-wrap: wrap; margin-top: var(--space-8); }
    .comp-feature { padding: var(--space-2) var(--space-8); border-radius: var(--radius-4); display: inline-flex; align-items: center; gap: var(--space-4); }
    .comp-feature.yes { background: oklch(0.982 0.018 155.826); color: oklch(0.527 0.154 150.069); }
    .comp-feature.no { background: var(--bg-base-secondary); color: var(--text-tertiary); }
    .comp-feature.warn { background: oklch(0.982 0.022 70.08); color: oklch(0.393 0.095 70.08); }
    .comp-score { display: flex; flex-direction: column; align-items: center; gap: var(--space-4); min-width: 64px; }
    .comp-score-ring { position: relative; }
    .comp-score-ring svg { transform: rotate(-90deg); }
    .comp-score-ring .score-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: var(--font-weight-bold); }
    .comp-issue { display: flex; align-items: flex-start; gap: var(--space-6); padding: var(--space-4) 0; color: var(--text-primary); }
    .comp-issue-icon.error { color: var(--color-danger); }
    .comp-issue-icon.warning { color: var(--color-warning); }
    .loc-badge { padding: var(--space-2) var(--space-8); border-radius: var(--radius-4); font-family: var(--font-family-mono); }
    .loc-badge.primary { background: oklch(0.982 0.018 155.826); color: oklch(0.527 0.154 150.069); }
    .loc-badge.legacy, .loc-badge.common { background: oklch(0.982 0.022 70.08); color: oklch(0.393 0.095 70.08); }
    .loc-badge.other { background: var(--bg-base-secondary); color: var(--text-secondary); }

    /* Migration */
    .mig-section { margin-bottom: var(--space-32); }
    .mig-section-header { display: flex; align-items: center; gap: var(--space-12); margin-bottom: var(--space-16); padding-bottom: var(--space-8); border-bottom: 2px solid var(--border-default); }
    .mig-section-badge { display: inline-flex; align-items: center; justify-content: center; padding: var(--space-4) var(--space-12); border-radius: var(--radius-6); font-weight: var(--font-weight-semibold); }
    .mig-section-badge.simple { background: oklch(0.982 0.018 155.826); color: oklch(0.527 0.154 150.069); }
    .mig-section-badge.moderate { background: oklch(0.982 0.022 70.08); color: oklch(0.393 0.095 70.08); }
    .mig-section-badge.complex { background: oklch(0.971 0.013 17.38); color: oklch(0.505 0.213 27.518); }
    .mig-card { background: var(--bg-base-primary); border: 1px solid var(--border-default); border-radius: var(--radius-12); padding: var(--space-24); margin-bottom: var(--space-12); transition: border-color 0.15s; }
    .mig-card:hover { border-color: var(--border-hover); }
    .mig-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-16); margin-bottom: var(--space-12); }
    .mig-swap { display: flex; align-items: center; gap: var(--space-8); }
    .mig-comp-name { font-weight: var(--font-weight-semibold); padding: var(--space-4) var(--space-12); border-radius: var(--radius-6); font-family: var(--font-family-mono); }
    .mig-comp-name.source { background: oklch(0.971 0.013 17.38); color: oklch(0.505 0.213 27.518); }
    .mig-comp-name.target { background: oklch(0.982 0.018 155.826); color: oklch(0.527 0.154 150.069); }
    .mig-arrow { color: var(--text-tertiary); font-size: 18px; }
    .mig-meta { display: flex; gap: var(--space-16); flex-wrap: wrap; margin-bottom: var(--space-12); }
    .mig-meta-item { display: flex; align-items: center; gap: var(--space-4); color: var(--text-secondary); }
    .mig-meta-value { font-weight: var(--font-weight-semibold); color: var(--text-main); }
    .mig-guidelines { background: var(--bg-base-primary-hover); border-radius: var(--radius-8); padding: var(--space-16); margin-bottom: var(--space-12); }
    .mig-guidelines-title { text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: var(--space-8); }
    .mig-guidelines-content { white-space: pre-wrap; line-height: 1.6; }
    .mig-props { background: var(--bg-base-primary-hover); border-radius: var(--radius-8); padding: var(--space-12) var(--space-16); margin-bottom: var(--space-12); border-left: 3px solid var(--color-info); }
    .mig-breaking { background: oklch(0.985 0.01 17.38); border-radius: var(--radius-8); padding: var(--space-12) var(--space-16); margin-bottom: var(--space-12); border-left: 3px solid var(--color-danger); }
    .mig-breaking-item { display: flex; align-items: flex-start; gap: var(--space-6); padding: var(--space-2) 0; }
    .mig-files-toggle { background: none; border: none; color: var(--color-accent); cursor: pointer; font-family: var(--font-family); padding: 0; }
    .mig-files-toggle:hover { text-decoration: underline; }
    .mig-file-list { display: none; margin-top: var(--space-8); }
    .mig-file-list.open { display: block; }
    .mig-file-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-4) var(--space-8); border-radius: var(--radius-4); }
    .mig-file-item:hover { background: var(--bg-base-primary-hover); }
    .mig-file-path { font-family: var(--font-family-mono); color: var(--text-primary); }
    .mig-file-count { color: var(--text-secondary); flex-shrink: 0; }
    .mig-complexity-filter { display: flex; gap: var(--space-8); }

    /* States */
    .empty-state { text-align: center; padding: var(--space-48); color: var(--text-secondary); }
    .empty-state .icon { font-size: 48px; margin-bottom: var(--space-12); }
    .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: var(--space-16); color: var(--text-secondary); }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border-default); border-top-color: var(--color-accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Migration Modal */
    .migration-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: var(--space-24);
      overflow-y: auto;
    }
    .migration-modal-content {
      background: var(--bg-base-primary);
      border-radius: var(--radius-12);
      padding: var(--space-24);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    .stat.clickable {
      cursor: pointer;
      transition: border-color 0.15s, box-shadow 0.15s;
      border: 1px solid transparent;
    }
    .stat.clickable:hover {
      border-color: var(--color-accent);
    }
    .stat.clickable.active {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 1px var(--color-accent);
    }

    @media (max-width: 768px) {
      .hero { grid-template-columns: 1fr; }
      .flags { grid-template-columns: 1fr; }
      .categories { grid-template-columns: 1fr 1fr; }
      .migration-modal-content {
        padding: var(--space-16);
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <div class="loading">
    <div class="spinner"></div>
    <div class="ts-d-m">Loading report...</div>
    <div class="ts-xxs-r" style="color: var(--text-tertiary);">
      Run <code style="background:var(--bg-base-secondary);padding:var(--space-2) var(--space-6);border-radius:var(--radius-4);">npx ds-coverage</code> first if no report exists.
    </div>
  </div>
</div>
<script>
// ============================================
// Dashboard ‚Äî reads categories and config from embedded data
// ============================================
const CFG = window.__DS_CONFIG__ || { title: 'DS Coverage', subtitle: '', categories: {}, componentAnalysisEnabled: false, roadmapEnabled: false, migrationEnabled: false, businessLogicAnalysisEnabled: false, purityEnabled: false, expectedProps: [], expectedSizes: [], forbiddenProps: [], forbiddenSizes: [] };
const CATS = CFG.categories;
const CAT_KEYS = Object.keys(CATS);

let report = null;
let activeTab = 'metrics';
let activeCategory = null;
let searchQuery = '';
let sortField = 'totalViolations';
let sortDir = 'desc';
let currentPage = 0;
const PAGE_SIZE = 50;
let detailFile = null;
const openPhases = new Set();
let tokenLocationFilter = 'all';
let tokenSearchQuery = '';
let tokenSortField = 'score';
let tokenSortDir = 'asc';
let apiLocationFilter = 'all';
let apiFeatureFilter = null;
let apiSearchQuery = '';
const openCompDetails = new Set();
let migComplexityFilter = 'all';
let migSearchQuery = '';
let migShowFilter = 'toMigrate'; // 'toMigrate' | 'migrated' | 'all'
const openMigFiles = new Set();
let openMigrationModal = null; // Component source name or null
let refactorRadarRiskFilter = 'all'; // 'all' | 'safe' | 'careful' | 'page-level'
let refactorRadarSearchQuery = '';

async function loadReport() {
  if (window.__DS_REPORT__) { report = window.__DS_REPORT__; render(); return; }
  try {
    const res = await fetch('./ds-coverage-report.json');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    report = await res.json();
    render();
  } catch (e) {
    document.getElementById('app').innerHTML = `<div class="empty-state"><div class="icon">üìä</div><h2 class="ts-xl-sb">No report found</h2><p class="ts-d-r" style="margin-top:var(--space-8)">Run the scanner first:</p><code style="display:inline-block;margin-top:var(--space-12);background:var(--bg-base-secondary);padding:var(--space-8) var(--space-16);border-radius:var(--radius-8);">npx ds-coverage</code></div>`;
  }
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function getCoverageColor(pct) { return pct >= 80 ? 'var(--color-success)' : pct >= 50 ? 'var(--color-warning)' : 'var(--color-danger)'; }

function renderRing(pct, size) {
  size = size || 160;
  const r = (size / 2) - 14;
  const circ = 2 * Math.PI * r;
  const off = circ * (1 - pct / 100);
  const c = getCoverageColor(pct);
  const sw = size > 80 ? 10 : 3;
  const fs = size > 80 ? 'var(--text-size-hero)' : 'var(--text-size-xxs)';
  return `<div class="${size > 80 ? 'hero-ring' : 'comp-score-ring'}" style="width:${size}px;height:${size}px"><svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="var(--border-default)" stroke-width="${sw}" /><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${c}" stroke-width="${sw}" stroke-dasharray="${circ}" stroke-dashoffset="${off}" stroke-linecap="round" /></svg><div class="${size > 80 ? 'label' : 'score-label ts-xxs-m'}" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:${c}"><span style="font-size:${fs};font-weight:var(--font-weight-bold);letter-spacing:-0.03em">${pct}%</span>${size > 80 ? '<span class="percent-label ts-xxs-m">Coverage</span>' : ''}</div></div>`;
}

function renderBadge(count, catKey) {
  if (count === 0) return `<span class="badge ts-xxs-m zero">${count}</span>`;
  const color = CATS[catKey]?.color || 'var(--color-danger)';
  return `<span class="badge ts-xxs-m" style="background:color-mix(in oklch, ${color} 12%, white);color:${color}">${count}</span>`;
}

function getFilteredFiles() {
  let files = report.files;
  if (activeCategory) files = files.filter(f => (f.violations[activeCategory]?.length || 0) > 0);
  if (searchQuery) { const q = searchQuery.toLowerCase(); files = files.filter(f => f.path.toLowerCase().includes(q)); }
  files = [...files].sort((a, b) => {
    let av, bv;
    if (sortField === 'path') { av = a.path; bv = b.path; return sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av); }
    if (CAT_KEYS.includes(sortField)) { av = a.violations[sortField]?.length || 0; bv = b.violations[sortField]?.length || 0; }
    else { av = a[sortField] || 0; bv = b[sortField] || 0; }
    return sortDir === 'asc' ? av - bv : bv - av;
  });
  return files;
}

function renderHeader() {
  const s = report.summary;
  const tabs = [{ id: 'metrics', label: 'Metrics ‚Äî App' }];
  if (CFG.componentAnalysisEnabled) tabs.push({ id: 'tokens', label: 'Metrics ‚Äî Design System' });
  if (CFG.migrationEnabled) tabs.push({ id: 'migration', label: 'Migration Plan' });
  if (CFG.roadmapEnabled) tabs.push({ id: 'roadmap', label: 'Refactoring Roadmap' });
  if (CFG.businessLogicAnalysisEnabled || CFG.purityEnabled) tabs.push({ id: 'refactor-radar', label: 'Refactor Radar' });
  return `<div class="header"><div><h1>${esc(CFG.title)}</h1><div class="subtitle ts-d-r">${esc(CFG.subtitle)}</div></div><div><span class="timestamp ts-xxs-r">Generated: ${new Date(report.generatedAt).toLocaleString()}</span></div></div><div class="tab-bar">${tabs.map(t => `<button class="tab-btn ts-d-m ${activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}</button>`).join('')}</div>`;
}

function renderMetrics() {
  const s = report.summary;
  const files = getFilteredFiles();
  const totalPages = Math.ceil(files.length / PAGE_SIZE);
  const pageFiles = files.slice(currentPage * PAGE_SIZE, (currentPage + 1) * PAGE_SIZE);
  const maxV = Math.max(...CAT_KEYS.map(k => s.categories[k]?.totalViolations || 0), 1);

  return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Metrics ‚Äî App</h2><p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">Design system compliance across all ${s.totalFilesScanned} files. Violations by category, flags, and per-file breakdown.</p>
  <div class="hero"><div style="display:flex;align-items:center;justify-content:center;">${renderRing(s.coveragePercent, 160)}</div>
  <div class="hero-stats">
    <div class="stat"><div class="stat-value">${s.totalFilesScanned}</div><div class="stat-label ts-xxs-m">Files scanned</div></div>
    <div class="stat"><div class="stat-value" style="color:var(--color-success)">${s.totalFilesScanned - s.totalFilesWithViolations}</div><div class="stat-label ts-xxs-m">Compliant</div></div>
    <div class="stat"><div class="stat-value" style="color:var(--color-danger)">${s.totalFilesWithViolations}</div><div class="stat-label ts-xxs-m">With debt</div></div>
    <div class="stat"><div class="stat-value">${s.totalViolations}</div><div class="stat-label ts-xxs-m">Total violations</div></div>
  </div></div>
  <div class="categories">${CAT_KEYS.map(k => { const cat = s.categories[k]; if (!cat) return ''; const m = CATS[k]; const w = (cat.totalViolations / maxV * 100).toFixed(1);
    return `<div class="cat-card ${activeCategory === k ? 'active' : ''}" onclick="toggleCategory('${k}')"><div class="cat-header"><span class="cat-name ts-xxs-m">${m.label}</span><span class="cat-icon">${m.icon}</span></div><div class="cat-count">${cat.totalViolations}</div><div class="cat-files ts-xxs-r">${cat.totalFiles} files</div><div class="cat-bar"><div class="cat-bar-fill" style="width:${w}%;background:${m.color}"></div></div></div>`;
  }).join('')}</div>
  <div class="flags">
    <div class="flag-card"><span class="flag-badge simple ts-xxs-m">@ds-migrate: simple</span><span class="flag-count">${s.flags.migrateSimple}</span></div>
    <div class="flag-card"><span class="flag-badge complex ts-xxs-m">@ds-migrate: complex</span><span class="flag-count">${s.flags.migrateComplex}</span></div>
    <div class="flag-card"><span class="flag-badge todo ts-xxs-m">@ds-todo</span><span class="flag-count">${s.flags.todo}</span></div>
  </div>
  <div class="toolbar"><input class="search-input ts-xs-r" type="text" placeholder="Filter by file path..." value="${searchQuery}" oninput="onSearch(this.value)" />
  <select class="sort-select ts-xs-r" onchange="onSort(this.value)"><option value="totalViolations-desc" ${sortField==='totalViolations'&&sortDir==='desc'?'selected':''}>Most violations</option><option value="totalViolations-asc" ${sortField==='totalViolations'&&sortDir==='asc'?'selected':''}>Least violations</option><option value="path-asc" ${sortField==='path'&&sortDir==='asc'?'selected':''}>Name A-Z</option>${CAT_KEYS.map(k=>`<option value="${k}-desc">${CATS[k].label} ‚Üì</option>`).join('')}</select></div>
  <div class="file-table-container"><table class="file-table"><thead><tr><th class="ts-xxs-m" style="width:45%">File</th><th class="ts-xxs-m">Total</th>${CAT_KEYS.map(k=>`<th class="ts-xxs-m">${CATS[k].label.slice(0,6)}</th>`).join('')}<th class="ts-xxs-m">Flags</th></tr></thead><tbody>
  ${pageFiles.length === 0 ? `<tr><td colspan="${CAT_KEYS.length + 3}" class="empty-state ts-d-r">No files match.</td></tr>` : pageFiles.map(f => `<tr onclick="showDetail('${f.path.replace(/'/g,"\\'")}')" style="cursor:pointer"><td><span class="file-path ts-xxs-r">${f.path}</span></td><td><strong class="ts-xs-m">${f.totalViolations}</strong></td>${CAT_KEYS.map(k=>`<td>${renderBadge(f.violations[k]?.length||0,k)}</td>`).join('')}<td>${f.totalFlags > 0 ? `<span class="badge ts-xxs-m" style="background:oklch(0.982 0.022 70.08);color:oklch(0.393 0.095 70.08)">${f.totalFlags}</span>` : renderBadge(0,'')}</td></tr>`).join('')}
  </tbody></table>${totalPages > 1 ? `<div class="pagination"><span class="ts-xxs-r">Showing ${currentPage*PAGE_SIZE+1}‚Äì${Math.min((currentPage+1)*PAGE_SIZE,files.length)} of ${files.length}</span><div style="display:flex;gap:var(--space-8)"><button class="ts-xxs-m" onclick="goPage(${currentPage-1})" ${currentPage===0?'disabled':''}>‚Üê Previous</button><button class="ts-xxs-m" onclick="goPage(${currentPage+1})" ${currentPage>=totalPages-1?'disabled':''}>Next ‚Üí</button></div></div>` : ''}</div>
  <div id="detail-panel" class="detail-panel"></div>`;
}

function renderTokens() {
  const api = report.componentApi;
  if (!api) return '<div class="empty-state ts-d-r">No component data.</div>';
  const s = api.summary;
  let components = api.components;
  if (tokenLocationFilter !== 'all') components = components.filter(c => c.location === tokenLocationFilter);
  if (tokenSearchQuery) { const q = tokenSearchQuery.toLowerCase(); components = components.filter(c => c.name.toLowerCase().includes(q) || c.path.toLowerCase().includes(q)); }
  components = [...components].sort((a, b) => { let av, bv; if (tokenSortField === 'name') return tokenSortDir === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name); if (tokenSortField === 'score') { av = a.tokenCoverage.score; bv = b.tokenCoverage.score; } else if (tokenSortField === 'violations') { av = a.tokenCoverage.totalViolations; bv = b.tokenCoverage.totalViolations; } else { av = a.tokenCoverage.violations[tokenSortField]||0; bv = b.tokenCoverage.violations[tokenSortField]||0; } return tokenSortDir === 'asc' ? av - bv : bv - av; });
  const total = components.length;
  const avg = total > 0 ? Math.round(components.reduce((s,c) => s + c.tokenCoverage.score, 0) / total * 100) / 100 : 100;
  const locations = Object.keys(s.byLocation);
  const sortI = (f) => tokenSortField === f ? (tokenSortDir === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
  return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Metrics ‚Äî Design System</h2><p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">Token compliance per component. Score = % of lines free from hardcoded values.</p>
  <div class="hero"><div style="display:flex;align-items:center;justify-content:center;">${renderRing(Math.round(avg), 160)}</div><div class="api-stats-grid">
    <div class="api-stat clickable ${tokenLocationFilter==='all'?'active':''}" onclick="setTokenFilter('all')"><div class="api-stat-value">${s.totalComponents}</div><div class="api-stat-label ts-xxs-m">Components</div></div>
    ${locations.map(l => `<div class="api-stat clickable ${tokenLocationFilter===l?'active':''}" onclick="setTokenFilter('${l}')"><div class="api-stat-value">${s.byLocation[l]}</div><div class="api-stat-label ts-xxs-m">in ${l}/</div></div>`).join('')}
    <div class="api-stat"><div class="api-stat-value" style="color:var(--color-success)">${s.tokenCompliantCount}</div><div class="api-stat-label ts-xxs-m">100% clean</div></div>
    <div class="api-stat"><div class="api-stat-value" style="color:var(--color-danger)">${s.totalComponents - s.tokenCompliantCount}</div><div class="api-stat-label ts-xxs-m">Need rework</div></div>
  </div></div>
  <div class="toolbar">
    <button class="api-loc-btn ts-xs-m ${tokenLocationFilter==='all'?'active':''}" onclick="setTokenFilter('all')">All (${s.totalComponents})</button>
    ${locations.map(l => `<button class="api-loc-btn ts-xs-m ${tokenLocationFilter===l?'active':''}" onclick="setTokenFilter('${l}')">${l}/ (${s.byLocation[l]})</button>`).join('')}
    <input class="search-input ts-xs-r" type="text" placeholder="Search component..." value="${tokenSearchQuery}" oninput="onTokenSearch(this.value)" />
  </div>
  <table class="token-table"><thead><tr><th class="ts-xxs-m" style="width:60px">Loc</th><th class="ts-xxs-m" style="cursor:pointer" onclick="onTokenSort('name')">Component${sortI('name')}</th><th class="ts-xxs-m" style="min-width:160px;cursor:pointer" onclick="onTokenSort('score')">Token Score${sortI('score')}</th><th class="ts-xxs-m" style="text-align:center;cursor:pointer" onclick="onTokenSort('violations')">Total${sortI('violations')}</th>${CAT_KEYS.map(k=>`<th class="ts-xxs-m" style="text-align:center;cursor:pointer" onclick="onTokenSort('${k}')">${CATS[k].label.slice(0,6)}${sortI(k)}</th>`).join('')}</tr></thead><tbody>
  ${components.map(c => { const tc = c.tokenCoverage; const color = getCoverageColor(tc.score); const sr = Math.round(tc.score);
    return `<tr><td><span class="loc-badge ${c.location} ts-xxs-m">${c.location}/</span></td><td><div class="ts-xs-m" style="font-weight:var(--font-weight-semibold)">${c.name}</div><div class="ts-xxs-r" style="color:var(--text-tertiary);font-family:var(--font-family-mono)">${c.path}</div></td><td><div class="token-score-bar"><div class="token-bar-track"><div class="token-bar-fill" style="width:${sr}%;background:${color}"></div></div><span class="token-score-pct ts-xs-m" style="color:${color}">${sr}%</span></div></td><td style="text-align:center">${tc.totalViolations > 0 ? `<strong class="ts-xs-m">${tc.totalViolations}</strong>` : '<span style="color:var(--color-success)" class="ts-xs-m">‚úì</span>'}</td>${CAT_KEYS.map(k=>`<td style="text-align:center">${renderBadge(tc.violations[k]||0,k)}</td>`).join('')}</tr>`; }).join('') || `<tr><td colspan="${CAT_KEYS.length+4}" class="empty-state ts-d-r">No components match.</td></tr>`}
  </tbody></table>`;
}

function renderApiRework() {
  const api = report.componentApi;
  if (!api) return '<div class="empty-state ts-d-r">No component API data.</div>';
  const s = api.summary;
  let components = api.components;
  const locations = Object.keys(s.byLocation);
  if (apiLocationFilter !== 'all') components = components.filter(c => c.location === apiLocationFilter);
  if (apiFeatureFilter) {
    const filters = { cva: c=>c.usesCVA, radix: c=>c.usesRadix, compound: c=>c.usesCompoundVariants, correctNaming: c=>!c.variantProps.some(p=>CFG.forbiddenProps.includes(p)), correctSizes: c=>!c.sizeValues.some(v=>CFG.forbiddenSizes.includes(v)), compliant: c=>c.complianceScore>=80 };
    const fn = filters[apiFeatureFilter]; if (fn) components = components.filter(fn);
  }
  if (apiSearchQuery) { const q = apiSearchQuery.toLowerCase(); components = components.filter(c => c.name.toLowerCase().includes(q) || c.path.toLowerCase().includes(q)); }

  return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Components ‚Äî API Redesign</h2><p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">Audit of reusable components against the API convention: CVA variants, expected props, sizes, compoundVariants.</p>
  <div class="hero"><div style="display:flex;align-items:center;justify-content:center;">${renderRing(s.avgComplianceScore, 160)}</div><div class="api-stats-grid">
    <div class="api-stat clickable ${apiLocationFilter==='all'&&!apiFeatureFilter?'active':''}" onclick="apiFeatureFilter=null;setApiFilter('all')"><div class="api-stat-value">${s.totalComponents}</div><div class="api-stat-label ts-xxs-m">Components</div></div>
    ${locations.map(l => `<div class="api-stat clickable ${apiLocationFilter===l?'active':''}" onclick="apiFeatureFilter=null;setApiFilter('${l}')"><div class="api-stat-value">${s.byLocation[l]}</div><div class="api-stat-label ts-xxs-m">in ${l}/</div></div>`).join('')}
    <div class="api-stat clickable ${apiFeatureFilter==='cva'?'active':''}" onclick="setApiFeatureFilter('cva')"><div class="api-stat-value">${s.usesCVA}</div><div class="api-stat-label ts-xxs-m">Use CVA</div></div>
    <div class="api-stat clickable ${apiFeatureFilter==='radix'?'active':''}" onclick="setApiFeatureFilter('radix')"><div class="api-stat-value">${s.usesRadix}</div><div class="api-stat-label ts-xxs-m">Use Radix</div></div>
    <div class="api-stat clickable ${apiFeatureFilter==='compound'?'active':''}" onclick="setApiFeatureFilter('compound')"><div class="api-stat-value">${s.usesCompoundVariants}</div><div class="api-stat-label ts-xxs-m">compoundVariants</div></div>
    <div class="api-stat clickable ${apiFeatureFilter==='correctNaming'?'active':''}" onclick="setApiFeatureFilter('correctNaming')"><div class="api-stat-value">${s.correctApiNaming}</div><div class="api-stat-label ts-xxs-m">Correct API</div></div>
    <div class="api-stat clickable ${apiFeatureFilter==='compliant'?'active':''}" onclick="setApiFeatureFilter('compliant')"><div class="api-stat-value" style="color:var(--color-success)">${s.compliantCount}</div><div class="api-stat-label ts-xxs-m">Compliant (‚â•80)</div></div>
  </div></div>
  <div class="toolbar">
    <button class="api-loc-btn ts-xs-m ${apiLocationFilter==='all'?'active':''}" onclick="setApiFilter('all')">All (${s.totalComponents})</button>
    ${locations.map(l => `<button class="api-loc-btn ts-xs-m ${apiLocationFilter===l?'active':''}" onclick="setApiFilter('${l}')">${l}/ (${s.byLocation[l]})</button>`).join('')}
    <input class="search-input ts-xs-r" type="text" placeholder="Search component..." value="${apiSearchQuery}" oninput="onApiSearch(this.value)" />
  </div>
  <div>${components.map(comp => { const isOpen = openCompDetails.has(comp.path); const features = [{l:'CVA',ok:comp.usesCVA},{l:'Radix',ok:comp.usesRadix},{l:'className',ok:comp.hasClassName},{l:'asChild',ok:comp.hasAsChild},{l:'compoundVariants',ok:comp.usesCompoundVariants}];
    const propsHtml = comp.variantProps.length > 0 ? `<div style="margin-top:var(--space-6)"><span class="ts-xxs-m" style="color:var(--text-secondary)">Props:</span> ${comp.variantProps.map(p => { const ok = CFG.expectedProps.includes(p); const bad = CFG.forbiddenProps.includes(p); return `<span class="comp-feature ts-xxs-m ${bad?'warn':ok?'yes':'no'}">${p}</span>`; }).join('')}</div>` : '';
    const sizesHtml = comp.sizeValues.length > 0 ? `<div style="margin-top:var(--space-4)"><span class="ts-xxs-m" style="color:var(--text-secondary)">Sizes:</span> ${comp.sizeValues.map(v => `<span class="comp-feature ts-xxs-m ${CFG.expectedSizes.includes(v)?'yes':'warn'}">${v}</span>`).join('')}</div>` : '';
    const issuesHtml = comp.issues.length > 0 ? `<div style="${isOpen?'':'display:none'};margin-top:var(--space-8)">${comp.issues.map(i => `<div class="comp-issue ts-xxs-r"><span class="comp-issue-icon ${i.severity}">${i.severity==='error'?'‚úï':'‚ö†'}</span><span>${esc(i.message)}</span></div>`).join('')}</div>` : '';
    return `<div class="comp-card" style="cursor:pointer" onclick="toggleCompDetail('${comp.path.replace(/'/g,"\\'")}')"><div><div style="display:flex;align-items:center;gap:var(--space-8);flex-wrap:wrap"><span class="ts-d-m" style="font-weight:var(--font-weight-semibold)">${comp.name}</span><span class="loc-badge ${comp.location} ts-xxs-m">${comp.location}/</span>${comp.issues.length>0?`<span class="ts-xxs-m" style="color:var(--text-secondary)">${comp.issues.filter(i=>i.severity==='error').length} errors, ${comp.issues.filter(i=>i.severity==='warning').length} warnings</span>`:'<span class="ts-xxs-m" style="color:var(--color-success)">‚úì No issues</span>'}</div><div style="font-family:var(--font-family-mono);color:var(--text-secondary)" class="ts-xxs-r">${comp.path}</div><div class="comp-features">${features.map(f=>`<span class="comp-feature ts-xxs-m ${f.ok?'yes':'no'}">${f.ok?'‚úì':'‚úï'} ${f.l}</span>`).join('')}</div>${propsHtml}${sizesHtml}${issuesHtml}</div><div class="comp-score">${renderRing(comp.complianceScore, 48)}</div></div>`; }).join('') || '<div class="empty-state ts-d-r">No components match.</div>'}</div>`;
}

function renderRoadmap() {
  const r = report.roadmap;
  if (!r) return '<div class="empty-state ts-d-r">No roadmap data.</div>';
  const phasesHtml = r.phases.map((p, i) => { const isOpen = openPhases.has(p.id);
    return `<div class="phase-card"><div class="phase-header"><div class="phase-title"><span class="phase-number ts-xxs-m">${i+1}</span><span class="ts-l-m">${p.title}</span></div></div><div class="phase-desc ts-xs-r">${p.description}</div>${p.businessCase?`<div class="biz-case"><div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4);text-transform:uppercase;letter-spacing:0.05em">Why prioritize</div><div class="ts-xs-r" style="color:var(--text-primary)">${p.businessCase}</div></div>`:''}<div class="phase-stats"><div><span class="phase-stat-value ts-d-m">${p.filesCount}</span><span class="phase-stat-label ts-xxs-r"> files</span></div><div><span class="phase-stat-value ts-d-m">${p.violationsCount}</span><span class="phase-stat-label ts-xxs-r"> violations</span></div></div><div class="phase-files"><button class="phase-files-toggle ts-xs-m" onclick="togglePhaseFiles('${p.id}')">${isOpen?'‚ñæ Hide files':'‚ñ∏ Show files'} (${p.files.length})</button><div class="phase-file-list ${isOpen?'open':''}">${p.files.map(f=>`<div class="phase-file-item"><span class="phase-file-path ts-xxs-r">${f.path}</span><span class="phase-file-count ts-xxs-m">${f.count}</span></div>`).join('')}</div></div></div>`; }).join('');
  const topDirs = r.directories.slice(0, 15);
  const dirHtml = topDirs.map(d => `<div class="dir-card"><div class="ts-xxs-m" style="font-family:var(--font-family-mono);margin-bottom:var(--space-8);word-break:break-all">${d.path}/</div><div class="dir-bar"><div class="dir-bar-fill" style="width:${d.coveragePercent}%;background:${getCoverageColor(d.coveragePercent)}"></div></div><div class="dir-stats ts-xxs-r"><span>${d.coveragePercent}% compliant</span><span>${d.filesWithViolations}/${d.totalFiles} with debt</span><span>${d.totalViolations} violations</span></div></div>`).join('');
  return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Refactoring Roadmap</h2><p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">Migration phases ordered by impact. Each includes a business case and affected files.</p>${phasesHtml}<h2 class="ts-xl-sb" style="margin-top:var(--space-32);margin-bottom:var(--space-8)">Coverage by Directory</h2><p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-16)">Directories sorted by most violations.</p><div class="dir-grid">${dirHtml}</div>`;
}

function renderMigration() {
  if (!CFG.migrationEnabled) {
    return '<div class="empty-state"><div class="icon">üîÑ</div><h2 class="ts-xl-sb">Migration Plan Disabled</h2><p class="ts-d-r" style="margin-top:var(--space-8)">Enable migration in your config:<br/><code style="background:var(--bg-base-secondary);padding:var(--space-4) var(--space-8);border-radius:var(--radius-4);margin-top:var(--space-8);display:inline-block">migration: { enabled: true, mappings: [...] }</code></p></div>';
  }
  const mig = report.migration;
  if (!mig) return '<div class="empty-state"><div class="icon">üîÑ</div><h2 class="ts-xl-sb">No migration plan</h2><p class="ts-d-r" style="margin-top:var(--space-8)">Configure the <code>migration</code> section in your ds-coverage config</p></div>';
  const ms = mig.summary;
  if (ms.totalMappings === 0) return '<div class="empty-state"><div class="icon">‚úÖ</div><h2 class="ts-xl-sb">No components to migrate</h2></div>';

  // Support older reports without totalToMigrate/totalMigrated/migrated
  const totalToMigrate = ms.totalToMigrate ?? ms.totalMappings;
  const totalMigrated = ms.totalMigrated ?? 0;
  const componentsWithMigrated = mig.components.map(c => ({ ...c, migrated: c.migrated ?? (c.totalUsages === 0) }));

  // Apply view filter: toMigrate (default), migrated, or all
  let components = componentsWithMigrated;
  if (migShowFilter === 'toMigrate') components = components.filter(c => !c.migrated);
  else if (migShowFilter === 'migrated') components = components.filter(c => c.migrated);
  if (migComplexityFilter !== 'all') components = components.filter(c => c.complexity === migComplexityFilter);
  if (migSearchQuery) { const q = migSearchQuery.toLowerCase(); components = components.filter(c => c.source.toLowerCase().includes(q) || c.target.toLowerCase().includes(q)); }

  // Legacy HTML block (hardcoded <input>, <textarea>, etc.)
  let legacyHtmlBlock = '';
  if (mig.legacyHtml && mig.legacyHtml.totalElements > 0) {
    const lh = mig.legacyHtml;
    const byEl = Object.entries(lh.byElement).filter(([, c]) => c.usages > 0).sort((a, b) => b[1].usages - a[1].usages);
    legacyHtmlBlock = `<div class="legacy-html-block" style="margin-bottom:var(--space-24);padding:var(--space-16);background:var(--surface-raised);border:1px solid var(--border-default);border-radius:var(--radius-m);">
      <div class="ts-xs-m" style="margin-bottom:var(--space-8);color:var(--text-secondary)">üìÑ Legacy HTML elements</div>
      <p class="ts-d-r" style="margin-bottom:var(--space-12)">Hardcoded native tags detected. Replace with design system components (see migration cards below).</p>
      <div style="display:flex;flex-wrap:wrap;gap:var(--space-16);align-items:center;margin-bottom:var(--space-12)">
        <div class="stat" style="min-width:80px"><div class="stat-value">${lh.totalElements}</div><div class="stat-label ts-xxs-m">Total</div></div>
        <div class="stat" style="min-width:80px"><div class="stat-value">${lh.totalFiles}</div><div class="stat-label ts-xxs-m">Files</div></div>
        ${byEl.map(([tag, c]) => `<span class="ts-xs-r" style="font-family:var(--font-family-mono)">&lt;${tag}&gt;</span> <span class="ts-xxs-m" style="color:var(--text-secondary)">${c.usages} (${c.files} files)</span>`).join('')}
      </div>
      ${lh.fileDetails.length > 0 ? `<details style="margin-top:var(--space-8)"><summary class="ts-xxs-m" style="cursor:pointer;color:var(--text-secondary)">‚ñ∏ By file (${lh.fileDetails.length})</summary><ul class="mig-file-list" style="margin-top:var(--space-8);max-height:200px;overflow:auto">${lh.fileDetails.slice(0, 30).map(f => `<li class="mig-file-item"><span class="mig-file-path ts-xxs-r">${f.path}</span><span class="ts-xxs-m">${f.total} element${f.total > 1 ? 's' : ''}</span> ${Object.entries(f.byElement).map(([tag, n]) => `<span class="ts-xxs-r" style="color:var(--text-secondary)">&lt;${tag}&gt;: ${n}</span>`).join(' ')}</li>`).join('')}</ul>${lh.fileDetails.length > 30 ? `<p class="ts-xxs-r" style="color:var(--text-secondary);margin-top:var(--space-4)">‚Ä¶ and ${lh.fileDetails.length - 30} more files</p>` : ''}</details>` : ''}
    </div>`;
  }

  // When showing only "to migrate" and none left, show success state
  if (migShowFilter === 'toMigrate' && totalToMigrate === 0) {
    const heroHtml = `<div class="hero" style="grid-template-columns: 1fr"><div class="hero-stats" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr))">
      <div class="stat"><div class="stat-value" style="color:var(--color-success)">0</div><div class="stat-label ts-xxs-m">To migrate</div></div>
      <div class="stat"><div class="stat-value" style="color:var(--color-success)">${totalMigrated}</div><div class="stat-label ts-xxs-m">Migrated</div></div>
    </div></div>`;
    return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Migration Plan ‚Üí ${esc(mig.targetDS)}</h2>
    <p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">All mapped components are migrated. No source usages detected.</p>
    ${legacyHtmlBlock}
    ${heroHtml}
    <div class="empty-state" style="margin-top:var(--space-24)"><div class="icon">‚úÖ</div><h2 class="ts-xl-sb">All components migrated</h2><p class="ts-d-r" style="margin-top:var(--space-8)">Switch to "Migrated" to see the list, or add new mappings in your config.</p></div>`;
  }

  // Group by complexity (and for migrated view, group migrated cards)
  const groups = { simple: [], moderate: [], complex: [] };
  for (const c of components) groups[c.complexity].push(c);

  const complexityLabels = { simple: '‚úÖ Simple', moderate: '‚ö†Ô∏è Moderate', complex: 'üî¥ Complex' };
  const complexityDescs = {
    simple: 'Direct swap ‚Äî compatible or near-compatible API. Import change + minimal renaming.',
    moderate: 'Adaptation required ‚Äî props to map, some logic adjustments needed.',
    complex: 'Significant refactoring ‚Äî different API, business logic to adapt, tests to rewrite.'
  };

  // Hero stats: to migrate (main) + migrated count
  const heroHtml = `<div class="hero" style="grid-template-columns: 1fr">
    <div class="hero-stats" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr))">
      <div class="stat"><div class="stat-value">${totalToMigrate}</div><div class="stat-label ts-xxs-m">To migrate</div></div>
      <div class="stat"><div class="stat-value" style="color:var(--color-success)">${totalMigrated}</div><div class="stat-label ts-xxs-m">Migrated</div></div>
      <div class="stat"><div class="stat-value">${ms.totalUsages}</div><div class="stat-label ts-xxs-m">Usages detected</div></div>
      <div class="stat"><div class="stat-value">${ms.totalFilesAffected}</div><div class="stat-label ts-xxs-m">Files affected</div></div>
      <div class="stat" style="cursor:pointer;${migComplexityFilter==='simple'?'box-shadow:0 0 0 2px var(--color-success);':''}" onclick="setMigFilter('simple')"><div class="stat-value" style="color:var(--color-success)">${ms.byComplexity.simple.count}</div><div class="stat-label ts-xxs-m">Simple</div></div>
      <div class="stat" style="cursor:pointer;${migComplexityFilter==='moderate'?'box-shadow:0 0 0 2px var(--color-warning);':''}" onclick="setMigFilter('moderate')"><div class="stat-value" style="color:var(--color-warning)">${ms.byComplexity.moderate.count}</div><div class="stat-label ts-xxs-m">Moderate</div></div>
      <div class="stat" style="cursor:pointer;${migComplexityFilter==='complex'?'box-shadow:0 0 0 2px var(--color-danger);':''}" onclick="setMigFilter('complex')"><div class="stat-value" style="color:var(--color-danger)">${ms.byComplexity.complex.count}</div><div class="stat-label ts-xxs-m">Complex</div></div>
    </div>
  </div>`;

  // Toolbar: view filter (To migrate / Migrated / All) + complexity + search
  const toolbarHtml = `<div class="toolbar">
    <div class="mig-complexity-filter" style="flex-wrap:wrap;gap:var(--space-8)">
      <button class="api-loc-btn ts-xs-m ${migShowFilter==='toMigrate'?'active':''}" onclick="setMigShowFilter('toMigrate')">To migrate (${totalToMigrate})</button>
      <button class="api-loc-btn ts-xs-m ${migShowFilter==='migrated'?'active':''}" onclick="setMigShowFilter('migrated')">‚úì Migrated (${totalMigrated})</button>
      <button class="api-loc-btn ts-xs-m ${migShowFilter==='all'?'active':''}" onclick="setMigShowFilter('all')">All (${ms.totalMappings})</button>
      <span style="width:1px;height:20px;background:var(--border-default);margin:0 var(--space-4)"></span>
      <button class="api-loc-btn ts-xs-m ${migComplexityFilter==='all'?'active':''}" onclick="setMigFilter('all')">All</button>
      <button class="api-loc-btn ts-xs-m ${migComplexityFilter==='simple'?'active':''}" onclick="setMigFilter('simple')">‚úÖ Simple (${ms.byComplexity.simple.count})</button>
      <button class="api-loc-btn ts-xs-m ${migComplexityFilter==='moderate'?'active':''}" onclick="setMigFilter('moderate')">‚ö†Ô∏è Moderate (${ms.byComplexity.moderate.count})</button>
      <button class="api-loc-btn ts-xs-m ${migComplexityFilter==='complex'?'active':''}" onclick="setMigFilter('complex')">üî¥ Complex (${ms.byComplexity.complex.count})</button>
    </div>
    <input class="search-input ts-xs-r" type="text" placeholder="Search a component..." value="${migSearchQuery}" oninput="onMigSearch(this.value)" style="max-width:280px" />
  </div>`;

  // Render component cards grouped by complexity
  let sectionsHtml = '';
  const orderToRender = migComplexityFilter === 'all' ? ['simple', 'moderate', 'complex'] : [migComplexityFilter];

  for (const level of orderToRender) {
    const groupComps = groups[level];
    if (!groupComps || groupComps.length === 0) continue;

    sectionsHtml += `<div class="mig-section">
      <div class="mig-section-header">
        <span class="mig-section-badge ${level} ts-xs-m">${complexityLabels[level]}</span>
        <span class="ts-xs-r" style="color:var(--text-secondary)">${groupComps.length} component${groupComps.length > 1 ? 's' : ''} ‚Äî ${complexityDescs[level]}</span>
      </div>
      ${groupComps.map(c => renderMigCard(c)).join('')}
    </div>`;
  }

  if (components.length === 0) {
    sectionsHtml = '<div class="empty-state ts-d-r">No components match the current filter.</div>';
  }

  return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Migration Plan ‚Üí ${esc(mig.targetDS)}</h2>
    <p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">Component-by-component migration plan. Each card includes guidelines, prop mapping, and affected files.</p>
    ${legacyHtmlBlock}
    ${heroHtml}${toolbarHtml}${sectionsHtml}`;
}

function renderMigCard(c) {
  const isOpen = openMigFiles.has(c.source);

  let guidelinesHtml = '';
  if (c.guidelines) {
    guidelinesHtml = `<div class="mig-guidelines">
      <div class="mig-guidelines-title ts-xxs-m">üìã Migration Guidelines</div>
      <div class="mig-guidelines-content ts-xs-r">${esc(c.guidelines)}</div>
    </div>`;
  }

  let propsHtml = '';
  if (c.propMapping) {
    propsHtml = `<div class="mig-props">
      <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">üîÄ Prop Mapping</div>
      <div class="ts-xs-r" style="font-family:var(--font-family-mono)">${esc(c.propMapping)}</div>
    </div>`;
  }

  let breakingHtml = '';
  if (c.breakingChanges && c.breakingChanges.length > 0) {
    breakingHtml = `<div class="mig-breaking">
      <div class="ts-xxs-m" style="color:var(--color-danger);margin-bottom:var(--space-4)">‚ö†Ô∏è Breaking changes</div>
      ${c.breakingChanges.map(bc => `<div class="mig-breaking-item ts-xs-r"><span style="color:var(--color-danger)">‚Ä¢</span><span>${esc(bc)}</span></div>`).join('')}
    </div>`;
  }

  const filesHtml = c.files.length > 0 ? `<div style="border-top:1px solid var(--border-default);padding-top:var(--space-12)">
    <button class="mig-files-toggle ts-xs-m" onclick="event.stopPropagation();toggleMigFiles('${c.source.replace(/'/g,"\\'")}')">
      ${isOpen ? '‚ñæ Hide files' : '‚ñ∏ Show files'} (${c.filesAffected})
    </button>
    <div class="mig-file-list ${isOpen ? 'open' : ''}">
      ${c.files.map(f => `<div class="mig-file-item">
        <span class="mig-file-path ts-xxs-r">${f.path}</span>
        <span class="mig-file-count ts-xxs-m">${f.totalOccurrences} occurrence${f.totalOccurrences > 1 ? 's' : ''}</span>
      </div>`).join('')}
    </div>
  </div>` : '';

  const migratedBadge = c.migrated ? '<span class="mig-section-badge simple ts-xxs-m" style="background:var(--color-success);color:var(--text-complementary)">‚úì Migrated</span>' : '';
  const cardStyle = c.migrated ? 'opacity:0.85;border-color:var(--color-success);' : '';
  return `<div class="mig-card" style="${cardStyle};cursor:pointer" onclick="showMigrationModal('${c.source.replace(/'/g,"\\'")}')">
    <div class="mig-card-header">
      <div class="mig-swap">
        <span class="mig-comp-name source ts-xs-m">${esc(c.source)}</span>
        <span class="mig-arrow">‚Üí</span>
        <span class="mig-comp-name target ts-xs-m">${esc(c.target)}</span>
      </div>
      <div style="display:flex;align-items:center;gap:var(--space-12);flex-wrap:wrap">
        ${migratedBadge}
        ${c.effort && !c.migrated ? `<span class="ts-xxs-m" style="color:var(--text-secondary)">‚è± ${esc(c.effort)}</span>` : ''}
        <span class="mig-section-badge ${c.complexity} ts-xxs-m">${c.complexity}</span>
      </div>
    </div>
    <div class="mig-meta">
      <div class="mig-meta-item ts-xxs-r"><span class="mig-meta-value">${c.totalUsages}</span> usages</div>
      <div class="mig-meta-item ts-xxs-r"><span class="mig-meta-value">${c.filesAffected}</span> files</div>
      <div class="mig-meta-item ts-xxs-r" style="font-family:var(--font-family-mono)">‚Üí ${esc(c.targetImportPath)}</div>
    </div>
    ${guidelinesHtml}${propsHtml}${breakingHtml}${filesHtml}
  </div>`;
}

function render() {
  let html = renderHeader();
  html += `<div class="tab-content ${activeTab==='metrics'?'active':''}">${renderMetrics()}</div>`;
  if (CFG.componentAnalysisEnabled) {
    html += `<div class="tab-content ${activeTab==='tokens'?'active':''}">${renderTokens()}</div>`;
  }
  if (CFG.migrationEnabled) html += `<div class="tab-content ${activeTab==='migration'?'active':''}">${renderMigration()}</div>`;
  if (CFG.roadmapEnabled) html += `<div class="tab-content ${activeTab==='roadmap'?'active':''}">${renderRoadmap()}</div>`;
  if (CFG.businessLogicAnalysisEnabled || CFG.purityEnabled) html += `<div class="tab-content ${activeTab==='refactor-radar'?'active':''}">${renderRefactorRadar()}</div>`;
  html += renderMigrationModal();
  document.getElementById('app').innerHTML = html;
  if (activeTab === 'metrics' && detailFile) showDetail(detailFile);
  if (openMigrationModal) updateMigrationModal();
}

function switchTab(t) { activeTab = t; render(); }
function toggleCategory(k) { activeCategory = activeCategory === k ? null : k; currentPage = 0; render(); }
function onSearch(v) { searchQuery = v; currentPage = 0; render(); const i = document.querySelector('.tab-content.active .search-input'); if (i) { i.focus(); i.selectionStart = i.selectionEnd = v.length; } }
function onSort(v) { const [f,d] = v.split('-'); sortField = f; sortDir = d; currentPage = 0; render(); }
function goPage(p) { currentPage = Math.max(0, p); render(); window.scrollTo({ top: document.querySelector('.file-table-container')?.offsetTop - 20, behavior: 'smooth' }); }
function setTokenFilter(l) { tokenLocationFilter = tokenLocationFilter === l ? 'all' : l; render(); }
function onTokenSearch(v) { tokenSearchQuery = v; render(); const i = document.querySelector('.tab-content.active .search-input'); if (i) { i.focus(); i.selectionStart = i.selectionEnd = v.length; } }
function onTokenSort(f) { if (tokenSortField === f) tokenSortDir = tokenSortDir === 'asc' ? 'desc' : 'asc'; else { tokenSortField = f; tokenSortDir = f === 'name' ? 'asc' : 'asc'; } render(); }
function setApiFilter(l) { apiLocationFilter = apiLocationFilter === l ? 'all' : l; render(); }
function setApiFeatureFilter(f) { apiFeatureFilter = apiFeatureFilter === f ? null : f; render(); }
function onApiSearch(v) { apiSearchQuery = v; render(); const i = document.querySelector('.tab-content.active .search-input'); if (i) { i.focus(); i.selectionStart = i.selectionEnd = v.length; } }
function toggleCompDetail(p) { if (openCompDetails.has(p)) openCompDetails.delete(p); else openCompDetails.add(p); render(); }
function togglePhaseFiles(id) { if (openPhases.has(id)) openPhases.delete(id); else openPhases.add(id); render(); }
function setMigFilter(level) { migComplexityFilter = migComplexityFilter === level ? 'all' : level; render(); }
function setMigShowFilter(view) { migShowFilter = view; render(); }
function onMigSearch(v) { migSearchQuery = v; render(); const i = document.querySelector('.tab-content.active .search-input'); if (i) { i.focus(); i.selectionStart = i.selectionEnd = v.length; } }
function toggleMigFiles(src) { if (openMigFiles.has(src)) openMigFiles.delete(src); else openMigFiles.add(src); render(); }

function showDetail(filePath) {
  detailFile = filePath;
  const file = report.files.find(f => f.path === filePath);
  if (!file) return;
  const allV = [];
  for (const [key, vs] of Object.entries(file.violations)) { for (const v of vs) allV.push({ ...v, cat: key }); }
  for (const v of file.flags.migrateSimple) allV.push({ ...v, cat: 'flag-simple' });
  for (const v of file.flags.migrateComplex) allV.push({ ...v, cat: 'flag-complex' });
  for (const v of file.flags.todo) allV.push({ ...v, cat: 'flag-todo' });
  allV.sort((a, b) => a.line - b.line);
  const panel = document.getElementById('detail-panel');
  panel.className = 'detail-panel open';
  panel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-16)"><h3 class="ts-d-m" style="font-family:var(--font-family-mono)">${file.path}</h3><button class="detail-close ts-xxs-m" onclick="closeDetail()">Close</button></div><div class="violation-list">${allV.map(v => { const c = CATS[v.cat]?.color || 'var(--color-info)'; return `<div class="violation-item"><span class="violation-line ts-xxs-r">L${v.line}</span><span class="violation-match ts-xxs-m" style="color:${c}">${v.match}</span><span class="violation-context ts-xxs-r">${esc(v.context)}</span></div>`; }).join('')}</div>`;
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function closeDetail() { detailFile = null; document.getElementById('detail-panel').className = 'detail-panel'; }

function renderRefactorRadar() {
  const hasBusinessLogic = report.businessLogic && Object.keys(report.businessLogic).length > 0;
  const hasImportBoundary = CFG.purityEnabled && report.importBoundary && Object.keys(report.importBoundary).length > 0;
  
  if (!hasBusinessLogic && !hasImportBoundary) {
    return '<div class="empty-state"><div class="icon">üìä</div><h2 class="ts-xl-sb">No refactor analysis</h2><p class="ts-d-r" style="margin-top:var(--space-8)">Enable businessLogicAnalysis or purity in your ds-coverage config</p></div>';
  }

  // Business Logic Analysis Section
  let businessLogicHtml = '';
  if (hasBusinessLogic) {
    let reports = Object.values(report.businessLogic);
    
    // Filter by risk level
    if (refactorRadarRiskFilter !== 'all' && refactorRadarRiskFilter !== 'pure' && refactorRadarRiskFilter !== 'impure' && refactorRadarRiskFilter !== 'server-coupled') {
      reports = reports.filter(r => r.complexity.riskLevel === refactorRadarRiskFilter);
    }
    
    // Filter by search
    if (refactorRadarSearchQuery) {
      const q = refactorRadarSearchQuery.toLowerCase();
      reports = reports.filter(r => r.path.toLowerCase().includes(q));
    }

    // Group by risk level
    const byRisk = { safe: [], careful: [], 'page-level': [] };
    for (const r of reports) {
      byRisk[r.complexity.riskLevel].push(r);
    }

    const safeCount = byRisk.safe.length;
    const carefulCount = byRisk.careful.length;
    const pageLevelCount = byRisk['page-level'].length;
    const total = safeCount + carefulCount + pageLevelCount;

    businessLogicHtml = `<div style="margin-bottom:var(--space-32)">
      <h3 class="ts-l-m" style="margin-bottom:var(--space-16)">Business Logic Analysis</h3>
      <div class="hero"><div style="display:flex;align-items:center;justify-content:center;">${renderRing(Math.round((safeCount / total * 100) || 0), 160)}</div>
      <div class="hero-stats">
        <div class="stat clickable ${refactorRadarRiskFilter==='safe'?'active':''}" onclick="setRefactorRadarFilter('safe')"><div class="stat-value" style="color:var(--color-success)">${safeCount}</div><div class="stat-label ts-xxs-m">Safe</div></div>
        <div class="stat clickable ${refactorRadarRiskFilter==='careful'?'active':''}" onclick="setRefactorRadarFilter('careful')"><div class="stat-value" style="color:var(--color-warning)">${carefulCount}</div><div class="stat-label ts-xxs-m">Careful</div></div>
        <div class="stat clickable ${refactorRadarRiskFilter==='page-level'?'active':''}" onclick="setRefactorRadarFilter('page-level')"><div class="stat-value" style="color:var(--color-danger)">${pageLevelCount}</div><div class="stat-label ts-xxs-m">Page-level</div></div>
        <div class="stat"><div class="stat-value">${total}</div><div class="stat-label ts-xxs-m">Total files</div></div>
      </div></div>
      <div class="toolbar">
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='all'?'active':''}" onclick="setRefactorRadarFilter('all')">All (${total})</button>
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='safe'?'active':''}" onclick="setRefactorRadarFilter('safe')">Safe (${safeCount})</button>
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='careful'?'active':''}" onclick="setRefactorRadarFilter('careful')">Careful (${carefulCount})</button>
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='page-level'?'active':''}" onclick="setRefactorRadarFilter('page-level')">Page-level (${pageLevelCount})</button>
        <input class="search-input ts-xs-r" type="text" placeholder="Search file path..." value="${refactorRadarSearchQuery}" oninput="onRefactorRadarSearch(this.value)" />
      </div>
      <div>${reports.map(r => {
        const riskColor = r.complexity.riskLevel === 'safe' ? 'var(--color-success)' : r.complexity.riskLevel === 'careful' ? 'var(--color-warning)' : 'var(--color-danger)';
        const riskLabel = r.complexity.riskLevel === 'safe' ? 'Safe' : r.complexity.riskLevel === 'careful' ? 'Careful' : 'Page-level';
        return `<div class="comp-card">
          <div>
            <div style="display:flex;align-items:center;gap:var(--space-8);flex-wrap:wrap;margin-bottom:var(--space-8)">
              <span class="ts-d-m" style="font-weight:var(--font-weight-semibold)">${esc(r.path)}</span>
              <span class="mig-section-badge ${r.complexity.riskLevel} ts-xxs-m">${riskLabel}</span>
              <span class="ts-xxs-m" style="color:var(--text-secondary)">Score: ${r.complexity.score}</span>
            </div>
            <div style="font-family:var(--font-family-mono);color:var(--text-secondary)" class="ts-xxs-r">${esc(r.suggestedRefactor.rationale)}</div>
            <div style="margin-top:var(--space-8)">
              <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Native HTML Elements:</div>
              <div style="display:flex;gap:var(--space-6);flex-wrap:wrap">
                ${Object.entries(r.nativeHtmlElements).filter(([k,v]) => k !== 'total' && v > 0).map(([k,v]) => `<span class="comp-feature ts-xxs-m yes">&lt;${k}&gt;: ${v}</span>`).join('')}
                ${r.nativeHtmlElements.total === 0 ? '<span class="ts-xxs-m" style="color:var(--text-tertiary)">None</span>' : ''}
              </div>
            </div>
            <div style="margin-top:var(--space-8)">
              <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Business Logic Signals:</div>
              <div style="display:flex;gap:var(--space-6);flex-wrap:wrap">
                ${r.businessLogicSignals.apiCalls > 0 ? `<span class="comp-feature ts-xxs-m warn">${r.businessLogicSignals.apiCalls} API call${r.businessLogicSignals.apiCalls > 1 ? 's' : ''}</span>` : ''}
                ${r.businessLogicSignals.useStateCount > 0 ? `<span class="comp-feature ts-xxs-m warn">${r.businessLogicSignals.useStateCount} useState</span>` : ''}
                ${r.businessLogicSignals.useEffectCount > 0 ? `<span class="comp-feature ts-xxs-m warn">${r.businessLogicSignals.useEffectCount} useEffect</span>` : ''}
                ${r.businessLogicSignals.fileUploads ? `<span class="comp-feature ts-xxs-m warn">File uploads</span>` : ''}
                ${r.businessLogicSignals.authFlows ? `<span class="comp-feature ts-xxs-m warn">Auth flows</span>` : ''}
                ${r.businessLogicSignals.formHandling ? `<span class="comp-feature ts-xxs-m warn">Form handling</span>` : ''}
                ${r.complexity.signals.length === 0 ? '<span class="ts-xxs-m" style="color:var(--text-tertiary)">None</span>' : ''}
              </div>
            </div>
            <div style="margin-top:var(--space-12);padding-top:var(--space-12);border-top:1px solid var(--border-default)">
              <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Suggested Actions:</div>
              <ul style="margin:0;padding-left:var(--space-16);color:var(--text-primary)" class="ts-xs-r">
                ${r.suggestedRefactor.suggestedActions.map(a => `<li>${esc(a)}</li>`).join('')}
              </ul>
            </div>
          </div>
          <div class="comp-score">${renderRing(r.complexity.score, 48)}</div>
        </div>`;
      }).join('') || '<div class="empty-state ts-d-r">No files match.</div>'}</div>`;
  }

  // Import Boundary / Purity Analysis Section
  let purityHtml = '';
  if (hasImportBoundary) {
    let purityReports = Object.values(report.importBoundary);
    
    // Filter by purity status
    if (refactorRadarRiskFilter === 'pure') {
      purityReports = purityReports.filter(r => r.purity === 'pure');
    } else if (refactorRadarRiskFilter === 'impure') {
      purityReports = purityReports.filter(r => r.purity === 'impure');
    } else if (refactorRadarRiskFilter === 'server-coupled') {
      purityReports = purityReports.filter(r => r.reasons.some(reason => reason.type === 'server-api'));
    }
    
    // Filter by search
    if (refactorRadarSearchQuery) {
      const q = refactorRadarSearchQuery.toLowerCase();
      purityReports = purityReports.filter(r => r.path.toLowerCase().includes(q));
    }

    const pureCount = purityReports.filter(r => r.purity === 'pure').length;
    const impureCount = purityReports.filter(r => r.purity === 'impure').length;
    const serverCoupledCount = purityReports.filter(r => r.reasons.some(reason => reason.type === 'server-api')).length;
    const totalPurity = purityReports.length;
    const purityPercent = totalPurity > 0 ? Math.round((pureCount / totalPurity) * 100) : 100;

    purityHtml = `<div>
      <h3 class="ts-l-m" style="margin-bottom:var(--space-16)">UI Purity Analysis</h3>
      <div class="hero"><div style="display:flex;align-items:center;justify-content:center;">${renderRing(purityPercent, 160)}</div>
      <div class="hero-stats">
        <div class="stat clickable ${refactorRadarRiskFilter==='pure'?'active':''}" onclick="setRefactorRadarFilter('pure')"><div class="stat-value" style="color:var(--color-success)">${pureCount}</div><div class="stat-label ts-xxs-m">Pure</div></div>
        <div class="stat clickable ${refactorRadarRiskFilter==='impure'?'active':''}" onclick="setRefactorRadarFilter('impure')"><div class="stat-value" style="color:var(--color-danger)">${impureCount}</div><div class="stat-label ts-xxs-m">Impure</div></div>
        <div class="stat clickable ${refactorRadarRiskFilter==='server-coupled'?'active':''}" onclick="setRefactorRadarFilter('server-coupled')"><div class="stat-value" style="color:var(--color-warning)">${serverCoupledCount}</div><div class="stat-label ts-xxs-m">Server-coupled</div></div>
        <div class="stat"><div class="stat-value">${totalPurity}</div><div class="stat-label ts-xxs-m">UI files</div></div>
      </div></div>
      <div class="toolbar">
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='all'?'active':''}" onclick="setRefactorRadarFilter('all')">All (${totalPurity})</button>
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='pure'?'active':''}" onclick="setRefactorRadarFilter('pure')">Pure (${pureCount})</button>
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='impure'?'active':''}" onclick="setRefactorRadarFilter('impure')">Impure (${impureCount})</button>
        <button class="api-loc-btn ts-xs-m ${refactorRadarRiskFilter==='server-coupled'?'active':''}" onclick="setRefactorRadarFilter('server-coupled')">Server-coupled (${serverCoupledCount})</button>
        <input class="search-input ts-xs-r" type="text" placeholder="Search file path..." value="${refactorRadarSearchQuery}" oninput="onRefactorRadarSearch(this.value)" />
      </div>
      <div>${purityReports.map(r => {
        const purityBadge = r.purity === 'pure' ? '<span class="mig-section-badge simple ts-xxs-m">Pure</span>' : '<span class="mig-section-badge complex ts-xxs-m">Impure</span>';
        const reasonsHtml = r.reasons.length > 0 ? `<div style="margin-top:var(--space-8)">
          <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Import Violations:</div>
          <ul style="margin:0;padding-left:var(--space-16);color:var(--text-primary)" class="ts-xs-r">
            ${r.reasons.map(reason => `<li>${esc(reason.message)}${reason.line ? ` (line ${reason.line})` : ''}${reason.resolvedPath ? ` ‚Üí ${esc(reason.resolvedPath)}` : ''}</li>`).join('')}
          </ul>
        </div>` : '';
        return `<div class="comp-card">
          <div>
            <div style="display:flex;align-items:center;gap:var(--space-8);flex-wrap:wrap;margin-bottom:var(--space-8)">
              <span class="ts-d-m" style="font-weight:var(--font-weight-semibold)">${esc(r.path)}</span>
              ${purityBadge}
              <span class="ts-xxs-m" style="color:var(--text-secondary)">Purity score: ${r.score}/100</span>
            </div>
            ${reasonsHtml}
          </div>
          <div class="comp-score">${renderRing(100 - r.score, 48)}</div>
        </div>`;
      }).join('') || '<div class="empty-state ts-d-r">No files match.</div>'}</div>`;
  }

  return `<h2 class="ts-xl-sb" style="margin-bottom:var(--space-8)">Refactor Radar</h2>
    <p class="ts-d-r" style="color:var(--text-secondary);margin-bottom:var(--space-24)">Business logic analysis and import boundary purity checking for refactoring.</p>
    ${businessLogicHtml}
    ${purityHtml}`;
}

function setRefactorRadarFilter(level) { refactorRadarRiskFilter = refactorRadarRiskFilter === level ? 'all' : level; render(); }
function onRefactorRadarSearch(v) { refactorRadarSearchQuery = v; render(); const i = document.querySelector('.tab-content.active .search-input'); if (i) { i.focus(); i.selectionStart = i.selectionEnd = v.length; } }

function showMigrationModal(componentSource) {
  openMigrationModal = componentSource;
  render();
  document.body.style.overflow = 'hidden';
}

function closeMigrationModal() {
  openMigrationModal = null;
  render();
  document.body.style.overflow = '';
}

function renderMigrationModal() {
  if (!openMigrationModal) return '';
  
  const migComp = report.migration?.components?.find(c => c.source === openMigrationModal);
  if (!migComp) return '';

  // Get business logic reports for affected files
  const fileAnalyses = migComp.files.map(f => ({
    file: f,
    businessLogic: report.businessLogic?.[f.path] || null,
    violations: report.files.find(fr => fr.path === f.path)?.violations || {}
  }));

  const riskColor = migComp.complexity === 'simple' ? 'var(--color-success)' : migComp.complexity === 'moderate' ? 'var(--color-warning)' : 'var(--color-danger)';
  const complexityLabel = migComp.complexity === 'simple' ? '‚úÖ Simple' : migComp.complexity === 'moderate' ? '‚ö†Ô∏è Moderate' : 'üî¥ Complex';

  return `<div id="migration-modal-overlay" class="migration-modal-overlay" onclick="closeMigrationModal()">
    <div class="migration-modal-content" onclick="event.stopPropagation()">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:var(--space-20)">
        <div>
          <h2 class="ts-xl-sb">${esc(migComp.source)} ‚Üí ${esc(migComp.target)}</h2>
          <div style="display:flex;align-items:center;gap:var(--space-8);margin-top:var(--space-8)">
            <span class="mig-section-badge ${migComp.complexity} ts-xs-m">${complexityLabel}</span>
            ${migComp.effort ? `<span class="ts-xs-r" style="color:var(--text-secondary)">‚è± ${esc(migComp.effort)}</span>` : ''}
          </div>
        </div>
        <button class="detail-close ts-xs-m" onclick="closeMigrationModal()">‚úï</button>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-16);margin-bottom:var(--space-20)">
        <div class="stat">
          <div class="stat-value">${migComp.totalUsages}</div>
          <div class="stat-label ts-xxs-m">Total usages</div>
        </div>
        <div class="stat">
          <div class="stat-value">${migComp.filesAffected}</div>
          <div class="stat-label ts-xxs-m">Files affected</div>
        </div>
      </div>

      ${migComp.guidelines ? `<div class="mig-guidelines" style="margin-bottom:var(--space-16)">
        <div class="mig-guidelines-title ts-xxs-m">üìã Migration Guidelines</div>
        <div class="mig-guidelines-content ts-xs-r">${esc(migComp.guidelines)}</div>
      </div>` : ''}

      ${migComp.propMapping ? `<div class="mig-props" style="margin-bottom:var(--space-16)">
        <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">üîÄ Prop Mapping</div>
        <div class="ts-xs-r" style="font-family:var(--font-family-mono)">${esc(migComp.propMapping)}</div>
      </div>` : ''}

      <div style="margin-top:var(--space-24);border-top:2px solid var(--border-default);padding-top:var(--space-20)">
        <h3 class="ts-l-m" style="margin-bottom:var(--space-16)">Business Logic Analysis</h3>
        <div style="max-height:400px;overflow-y:auto">
          ${fileAnalyses.map(fa => {
            if (!fa.businessLogic) return `<div class="mig-file-item" style="padding:var(--space-12);border:1px solid var(--border-default);border-radius:var(--radius-8);margin-bottom:var(--space-8)">
              <div class="ts-xs-m" style="font-family:var(--font-family-mono);margin-bottom:var(--space-4)">${esc(fa.file.path)}</div>
              <div class="ts-xxs-r" style="color:var(--text-tertiary)">No business logic analysis available</div>
            </div>`;
            
            const bl = fa.businessLogic;
            const riskColor = bl.complexity.riskLevel === 'safe' ? 'var(--color-success)' : bl.complexity.riskLevel === 'careful' ? 'var(--color-warning)' : 'var(--color-danger)';
            return `<div class="mig-file-item" style="padding:var(--space-16);border:1px solid var(--border-default);border-radius:var(--radius-8);margin-bottom:var(--space-12)">
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:var(--space-12)">
                <div class="ts-xs-m" style="font-family:var(--font-family-mono)">${esc(fa.file.path)}</div>
                <span class="mig-section-badge ${bl.complexity.riskLevel} ts-xxs-m">${bl.complexity.riskLevel === 'safe' ? 'Safe' : bl.complexity.riskLevel === 'careful' ? 'Careful' : 'Page-level'}</span>
              </div>
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-12);margin-bottom:var(--space-12)">
                <div>
                  <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Native HTML:</div>
                  <div style="display:flex;gap:var(--space-4);flex-wrap:wrap">
                    ${bl.nativeHtmlElements.total > 0 ? Object.entries(bl.nativeHtmlElements).filter(([k,v]) => k !== 'total' && v > 0).map(([k,v]) => `<span class="ts-xxs-r" style="background:var(--bg-base-secondary);padding:var(--space-2) var(--space-6);border-radius:var(--radius-4)">&lt;${k}&gt;: ${v}</span>`).join('') : '<span class="ts-xxs-r" style="color:var(--text-tertiary)">None</span>'}
                  </div>
                </div>
                <div>
                  <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Signals:</div>
                  <div style="display:flex;gap:var(--space-4);flex-wrap:wrap">
                    ${bl.businessLogicSignals.apiCalls > 0 ? `<span class="ts-xxs-r" style="background:var(--bg-base-secondary);padding:var(--space-2) var(--space-6);border-radius:var(--radius-4)">${bl.businessLogicSignals.apiCalls} API</span>` : ''}
                    ${bl.businessLogicSignals.useStateCount > 0 ? `<span class="ts-xxs-r" style="background:var(--bg-base-secondary);padding:var(--space-2) var(--space-6);border-radius:var(--radius-4)">${bl.businessLogicSignals.useStateCount} useState</span>` : ''}
                    ${bl.businessLogicSignals.useEffectCount > 0 ? `<span class="ts-xxs-r" style="background:var(--bg-base-secondary);padding:var(--space-2) var(--space-6);border-radius:var(--radius-4)">${bl.businessLogicSignals.useEffectCount} useEffect</span>` : ''}
                    ${bl.complexity.signals.length === 0 ? '<span class="ts-xxs-r" style="color:var(--text-tertiary)">None</span>' : ''}
                  </div>
                </div>
              </div>
              <div>
                <div class="ts-xxs-m" style="color:var(--text-secondary);margin-bottom:var(--space-4)">Suggested Actions:</div>
                <ul style="margin:0;padding-left:var(--space-16);color:var(--text-primary)" class="ts-xxs-r">
                  ${bl.suggestedRefactor.suggestedActions.slice(0, 3).map(a => `<li>${esc(a)}</li>`).join('')}
                </ul>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

function updateMigrationModal() {
  const modal = document.getElementById('migration-modal-overlay');
  if (modal) {
    modal.scrollTop = 0;
  }
}

// ESC key handler
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && openMigrationModal) {
    closeMigrationModal();
  }
});

loadReport();
</script>
</body>
</html>
